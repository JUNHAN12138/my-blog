# fetchå¯è¯»æµ

## ä»£ç ç¤ºä¾‹

```tsx
export default function useReadableStreams(props){
    async function main() {
      // ä½¿ç”¨è½¬æ¢å™¨åˆ›å»ºè½¬æ¢æµ
      const ts = new TransformStream(new Uint8ArrayToStringsTransformer())
      // è·å–æ–‡æœ¬æ–‡ä»¶
      const response = await fetch('goethe-faust-1.txt',{
        method:'',
        body:JSON.stringfy({data:data}),
        headers:{"X-XSRF-TOKEN":"...."},
        mode:"cors",//è·¨åŸŸ
        cache:"default",
        credentials:'include'
      })
      // Get a ReadableStream on the text file's body\
      // response?._bodyBlob?.stream();å…¼å®¹ç§»åŠ¨ç«¯é’‰é’‰è¯·æ±‚æ•°æ®ç»“æ„
      const rs = response.body;
      // åœ¨ReadableStreamä¸Šåº”ç”¨Transformerä»¥åˆ›å»ºå­—ç¬¦ä¸²æµ
      const lineStream = rs.pipeThrough(ts)
      // è¯»å–å­—ç¬¦ä¸²æµ
      const reader = lineStream.getReader()
      while (true) {
        const { done, value } = await reader.read()
        if (done) {
          break
        }

        // å°†æ–‡æ¡£ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²è¡Œä½œä¸ºæ®µè½
        const p = document.createElement('p')
        p.textContent = value
        document.getElementById('section').appendChild(p)
      }
    }

    main().catch(() => {
      if (typeof TransformStream === 'undefined') {
        const error = document.createElement('p')
        error.textContent = 'TransformStream is not available in your browser. Activate it in Chrome with chrome://flags/#enable-experimental-web-platform-features'
        error.style.color = 'red'
        document.getElementById('section').appendChild(error)
      }
    }) 
}
```

åœ¨æ·»åŠ æ­¤æ’ä»¶çš„index.htmlä¸Šæ·»åŠ ä¸Š` <meta charset="UTF-8">`

```tsx
/**
 * æ­¤è½¬æ¢å™¨ä»â€œfetchâ€è·å–äºŒè¿›åˆ¶Uint8Arrayå—`
 * å¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºå­—ç¬¦ä¸²å—ã€‚
 *
 * @implements {TransformStreamTransformer}
 */
class Uint8ArrayToStringsTransformer {
  constructor() {
    this.decoder = new TextDecoder()
    this.lastString = ''
  }

  /**
   * ä»â€œfetchâ€ä¸­æ¥æ”¶ä¸‹ä¸€ä¸ªUint8Arrayå—å¹¶å¯¹å…¶è¿›è¡Œè½¬æ¢ã€‚
   *
   * @paramï½›Uint8Arrayï½chunkä¸‹ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ®å—ã€‚
   * @paramï½›TransformStreamDefaultControllerï½controllerè¦å°†å˜æ¢å—æ’å…¥é˜Ÿåˆ—çš„æ§åˆ¶å™¨ã€‚
   */
  transform(chunk, controller) {
    console.log('Received chunk %o with %d bytes.', chunk, chunk.byteLength)

    // å°†å½“å‰å—è§£ç ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æœ€åä¸€ä¸ªå­—ç¬¦ä¸²å‰åŠ ä¸Šå‰ç¼€
    const string = `${this.lastString}${this.decoder.decode(chunk)}`

    // ä»å—ä¸­æå–è¡Œ
    const lines = string.split(/\r\n|[\r\n]/g)

    // ä¿å­˜æœ€åä¸€è¡Œï¼Œå› ä¸ºå®ƒå¯èƒ½ä¸å®Œæ•´
    this.lastString = lines.pop() || ''

    // å°†ä¸‹ä¸€å—ä¸­çš„æ¯ä¸€è¡Œæ’é˜Ÿ
    for (const line of lines) {
      controller.enqueue(line)
    }
  }

  /**
   * å½“â€œfetchâ€å·²å®Œæˆå¯¹æ­¤è½¬æ¢æµçš„å†™å…¥æ—¶è°ƒç”¨ã€‚
   *
   * @paramï½›TransformStreamDefaultControllerï½controllerè¦å°†å˜æ¢å—æ’å…¥é˜Ÿåˆ—çš„æ§åˆ¶å™¨ã€‚
   */
  flush(controller) {
    // è¿˜æœ‰ä¸€æ¡çº¿å—ï¼Ÿå°†å…¶æ’é˜Ÿ
    if (this.lastString) {
      controller.enqueue(this.lastString)
    }
  }
}
```

## tips

### TextDecoder

`TextDecoder` æ¥å£è¡¨ç¤ºä¸€ä¸ªæ–‡æœ¬è§£ç å™¨ï¼Œä¸€ä¸ªè§£ç å™¨åªæ”¯æŒä¸€ç§ç‰¹å®šæ–‡æœ¬ç¼–ç ï¼Œä¾‹å¦‚ `UTF-8` ã€`ISO-8859-2` ã€`KOI8-R` ã€`GBK` ï¼Œç­‰ç­‰ï¼Œè§£ç å™¨å°†å­—èŠ‚æµä½œä¸ºè¾“å…¥ï¼Œå¹¶æä¾›ç ä½æµä½œä¸ºè¾“å‡ºã€‚

*`TextDecoder` æ¥å£ä¸ç»§æ‰¿ä»»ä½•æ–¹æ³•*ã€‚è¿”å›ä»¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«ä½¿ç”¨ç‰¹å®š `TextDecoder`å¯¹è±¡çš„æ–¹æ³•è§£ç çš„æ–‡æœ¬ã€‚

```ts
//å¤„ç†utf-8æ–‡æœ¬
let utf8decoder = new TextDecoder(); // default 'utf-8' or 'utf8'

let u8arr = new Uint8Array([240, 160, 174, 183]);
let i8arr = new Int8Array([-16, -96, -82, -73]);
let u16arr = new Uint16Array([41200, 47022]);
let i16arr = new Int16Array([-24336, -18514]);
let i32arr = new Int32Array([-1213292304]);

console.log(utf8decoder.decode(u8arr));
console.log(utf8decoder.decode(i8arr));
console.log(utf8decoder.decode(u16arr));
console.log(utf8decoder.decode(i16arr));
console.log(utf8decoder.decode(i32arr));
```

```ts
//å¤„ç†éUTF-8æ–‡æœ¬ï¼Œ
//åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯¹ä¿„è¯­æ–‡æœ¬â€œĞŸÑ€Ğ¸Ğ²ĞµÑ‚ï¼ŒĞ¼Ğ¸Ñ€ï¼â€è¿›è¡Œç¼–ç ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼ˆ"Hello, world."ï¼‰ã€‚åœ¨æˆ‘ä»¬çš„ TextDecoder() æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šé€‚ç”¨äºè¥¿é‡Œå°”å­—æ¯çš„ Windows-1251 å­—ç¬¦ç¼–ç ã€‚
const win1251decoder = new TextDecoder("windows-1251");
const bytes = new Uint8Array([
  207, 240, 232, 226, 229, 242, 44, 32, 236, 232, 240, 33,
]);
console.log(win1251decoder.decode(bytes)); // ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ¼Ğ¸Ñ€!
```

> è§£æUint8Arrayçš„å­—ç¬¦é›†æ—¶å¯ä»¥ä½¿ç”¨ `textDecoder("")`æ–¹æ³•å®šä¹‰å¸¸é‡ï¼Œç„¶ådecodeï¼ˆå­—ç¬¦é›†ï¼‰å³å¯



# WebSocketé•¿è¿æ¥

## ä»£ç ç¤ºä¾‹

```tsx
import React, { useRef, useMemo } from 'react';
import { useWebSocket } from 'ahooks';

enum ReadyState {
  Connecting = 0,
  Open = 1,
  Closing = 2,
  Closed = 3,
}

export default () => {
  const messageHistory = useRef<any[]>([]);

  const { readyState, sendMessage, latestMessage, disconnect, connect } = useWebSocket(
    'wss://demo.piesocket.com/v3/channel_1?api_key=VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV&notify_self',
  );

  messageHistory.current = useMemo(
    () => messageHistory.current.concat(latestMessage),
    [latestMessage],
  );

  return (
    <div>
      {/* send message */}
      <button
        onClick={() => sendMessage && sendMessage(`${Date.now()}`)}
        disabled={readyState !== ReadyState.Open}
        style={{ marginRight: 8 }}
      >
        âœ‰ï¸ send
      </button>
      {/* disconnect */}
      <button
        onClick={() => disconnect && disconnect()}
        disabled={readyState !== ReadyState.Open}
        style={{ marginRight: 8 }}
      >
        âŒ disconnect
      </button>
      {/* connect */}
      <button onClick={() => connect && connect()} disabled={readyState === ReadyState.Open}>
        {readyState === ReadyState.Connecting ? 'connecting' : 'ğŸ“ connect'}
      </button>
      <div style={{ marginTop: 8 }}>readyState: {readyState}</div>
      <div style={{ marginTop: 8 }}>
        <p>received message: </p>
        {messageHistory.current.map((message, index) => (
          <p key={index} style={{ wordWrap: 'break-word' }}>
            {message?.data}
          </p>
        ))}
      </div>
    </div>
  );
};
```

ä½¿ç”¨useRefå­˜å‚¨å¤§é‡é•¿è¿æ¥æ•°æ®ï¼Œå¯ä»¥å‡å°‘æ¸²æŸ“



